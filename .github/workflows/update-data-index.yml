name: æ›´æ–° GitHub Pages æ•°æ®ç´¢å¼•

# å½“ archive ç›®å½•æœ‰æ–°æ•°æ®æ—¶è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    paths:
      - "archive/**/*.json"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤© UTC 3:00 (åŒ—äº¬æ—¶é—´ 11:00) è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
    - cron: "0 3 * * *"

jobs:
  update-data-index:
    runs-on: ubuntu-latest

    permissions:
      contents: write # éœ€è¦å†™æƒé™æ¥æäº¤æ›´æ–°
      pages: write # éœ€è¦ Pages æƒé™
      id-token: write # éœ€è¦ OIDC token

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²è®°å½•ä»¥ç¡®ä¿èƒ½çœ‹åˆ°æ‰€æœ‰æ›´æ”¹
          fetch-depth: 0

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸ“Š æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€
        run: |
          echo "=== Current Archive Status ==="
          find archive -name "*.json" | wc -l | xargs echo "Total JSON files:"
          ls -la archive/ | wc -l | xargs echo "Country directories:"

          echo ""
          echo "=== Latest files in each country ==="
          for country in archive/*/; do
            if [ -d "$country" ]; then
              country_name=$(basename "$country")
              latest_file=$(ls -1t "$country"*.json 2>/dev/null | head -1)
              if [ -n "$latest_file" ]; then
                echo "$country_name: $(basename "$latest_file")"
              else
                echo "$country_name: no files"
              fi
            fi
          done

          echo ""
          echo "=== Current data-index.js status ==="
          if [ -f "page/data-index.js" ]; then
            echo "data-index.js exists"
            # æå–ç”Ÿæˆæ—¶é—´
            grep -o "generated.*" page/data-index.js | head -1 || echo "No generation time found"
          else
            echo "data-index.js does not exist"
          fi

      - name: ğŸ”§ åˆ›å»ºè„šæœ¬ç›®å½•
        run: mkdir -p scripts

      - name: ğŸ“ ç”Ÿæˆæ•°æ®ç´¢å¼•
        run: |
          echo "ğŸš€ Running data index generation..."
          node scripts/generate-data-index.js

          echo ""
          echo "=== Generated data-index.js preview ==="
          head -20 page/data-index.js

          echo ""
          echo "=== File size comparison ==="
          if [ -f "page/data-index.js" ]; then
            wc -c page/data-index.js | xargs echo "New data-index.js size (bytes):"
          fi

      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check-changes
        run: |
          # æ£€æŸ¥ data-index.js æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet page/data-index.js; then
            echo "No changes detected in data-index.js"
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in data-index.js"
            echo "has-changes=true" >> $GITHUB_OUTPUT
            
            echo ""
            echo "=== Changes preview ==="
            git --no-pager diff page/data-index.js | head -50
          fi

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ”¹
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          # é…ç½® Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æ›´æ”¹
          git add page/data-index.js

          # åˆ›å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ¤– Auto-update data index - $(date '+%Y-%m-%d %H:%M UTC')"
          git commit -m "$COMMIT_MSG"

          # æ¨é€æ›´æ”¹
          git push

          echo "âœ… Changes committed and pushed successfully"

      - name: ğŸ“‹ è¿è¡Œæ€»ç»“
        run: |
          echo "=== Update Summary ==="
          echo "Workflow completed successfully!"

          if [ "${{ steps.check-changes.outputs.has-changes }}" == "true" ]; then
            echo "âœ… Data index was updated and committed"
          else
            echo "â„¹ï¸ No updates were needed"
          fi

          echo ""
          echo "=== Final Status ==="
          find archive -name "*.json" | wc -l | xargs echo "Total archive files:"

          if [ -f "page/data-index.js" ]; then
            grep -o '"totalFiles": *[0-9]*' page/data-index.js | head -1 || echo "Could not extract total files count"
            grep -o '"generated": *"[^"]*"' page/data-index.js | head -1 || echo "Could not extract generation time"
          fi

      - name: ğŸš€ è§¦å‘ GitHub Pages éƒ¨ç½²
        if: steps.check-changes.outputs.has-changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // è§¦å‘ GitHub Pages é‡æ–°éƒ¨ç½²
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'pages.yml',  // å¦‚æœæ‚¨æœ‰è‡ªå®šä¹‰çš„ Pages workflow
                ref: 'main'
              });
              console.log('âœ… GitHub Pages deployment triggered');
            } catch (error) {
              console.log('â„¹ï¸ Could not trigger custom Pages workflow, relying on automatic deployment');
            }
