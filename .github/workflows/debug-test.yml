name: è°ƒè¯•æµ‹è¯•æ”¶é›†

on:
  workflow_dispatch:
    inputs:
      target_country:
        description: "æµ‹è¯•å›½å®¶"
        required: false
        default: "China"
        type: choice
        options:
          - "China"
          - "Japan"
          - "UnitedStates"

permissions:
  contents: write
  actions: read

jobs:
  debug-collection:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: æ¢å¤ä¾èµ–åŒ…å’Œæ„å»º
      run: |
        echo "=== æ„å»ºé¡¹ç›® ==="
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "âœ… æ„å»ºå®Œæˆ"

    - name: æ£€æŸ¥åˆå§‹çŠ¶æ€
      run: |
        echo "=== åˆå§‹çŠ¶æ€æ£€æŸ¥ ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        echo "æ˜¯å¦å­˜åœ¨ BingWallpaperData:"
        if [ -d "BingWallpaperData" ]; then
          echo "âœ… BingWallpaperData ç›®å½•å·²å­˜åœ¨"
          find BingWallpaperData -name "*.json" | head -5
        else
          echo "âŒ BingWallpaperData ç›®å½•ä¸å­˜åœ¨"
        fi

    - name: è¿è¡Œæ”¶é›†ç¨‹åº
      run: |
        echo "=== å¼€å§‹æ”¶é›† ${{ github.event.inputs.target_country }} å£çº¸ä¿¡æ¯ ==="
        dotnet run --configuration Release
        echo "=== ç¨‹åºæ‰§è¡Œå®Œæˆ ==="
      env:
        AUTO_MODE: "true"
        COLLECT_ALL_COUNTRIES: "false"
        TARGET_COUNTRY: "${{ github.event.inputs.target_country }}"
        COLLECT_DAYS: "1"
        CONCURRENT_REQUESTS: "1"
        JSON_FORMAT: "pretty"

    - name: è¯¦ç»†æ£€æŸ¥ç»“æœ
      run: |
        echo "=== è¯¦ç»†ç»“æœæ£€æŸ¥ ==="
        echo "æ‰§è¡Œåçš„ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        
        if [ -d "BingWallpaperData" ]; then
          echo "âœ… BingWallpaperData ç›®å½•å­˜åœ¨"
          echo "å®Œæ•´ç›®å½•ç»“æ„:"
          find BingWallpaperData -type f
          echo ""
          echo "JSONæ–‡ä»¶å†…å®¹æ£€æŸ¥:"
          find BingWallpaperData -name "*.json" -exec echo "æ–‡ä»¶: {}" \; -exec head -5 {} \; -exec echo "" \;
        else
          echo "âŒ BingWallpaperData ç›®å½•ä»ç„¶ä¸å­˜åœ¨"
          echo "è¿™è¯´æ˜ç¨‹åºæ²¡æœ‰åˆ›å»ºä»»ä½•æ–‡ä»¶"
        fi
        
        echo ""
        echo "Git çŠ¶æ€:"
        git status --porcelain
        git status

    - name: å°è¯•æ‰‹åŠ¨åˆ›å»ºæµ‹è¯•æ–‡ä»¶
      run: |
        echo "=== æ‰‹åŠ¨åˆ›å»ºæµ‹è¯• ==="
        mkdir -p BingWallpaperData/TestCountry/2025-01-15
        echo '{"test": "manual test file", "date": "2025-01-15"}' > BingWallpaperData/TestCountry/2025-01-15/test.json
        echo "æ‰‹åŠ¨åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶:"
        cat BingWallpaperData/TestCountry/2025-01-15/test.json
        echo ""
        echo "æ‰‹åŠ¨åˆ›å»ºåçš„ Git çŠ¶æ€:"
        git status --porcelain

    - name: å°è¯•æäº¤æµ‹è¯•
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Debug"
        
        echo "=== å°è¯•æäº¤æµ‹è¯• ==="
        CHANGES=$(git status --porcelain)
        if [ -n "$CHANGES" ]; then
          echo "âœ… å‘ç°å˜æ›´ï¼Œå°è¯•æäº¤:"
          echo "$CHANGES"
          
          git add BingWallpaperData/
          echo "å·²æ·»åŠ åˆ°æš‚å­˜åŒº"
          
          git commit -m "ğŸ§ª è°ƒè¯•æµ‹è¯• - ${{ github.event.inputs.target_country }} - $(date +'%Y-%m-%d %H:%M UTC')"
          echo "å·²åˆ›å»ºæäº¤"
          
          echo "å‡†å¤‡æ¨é€..."
          git push
          echo "âœ… æ¨é€æˆåŠŸï¼"
        else
          echo "âŒ æ²¡æœ‰å‘ç°ä»»ä½•å˜æ›´"
          echo "è¿™è¯´æ˜æ–‡ä»¶åˆ›å»ºæˆ–Gitæ£€æµ‹å­˜åœ¨é—®é¢˜"
        fi
