name: å¼ºåˆ¶æ”¶é›†æ‰€æœ‰å›½å®¶ä»Šæ—¥å£çº¸

on:
  workflow_dispatch:
    inputs:
      force_overwrite:
        description: 'å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶'
        required: false
        default: false
        type: boolean
      collect_days:
        description: 'æ”¶é›†å¤©æ•° (1-8)'
        required: false
        default: '1'
        type: string

permissions:
  contents: write
  actions: read

jobs:
  force-collect-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        country: [
          China, UnitedStates, UnitedKingdom, Japan, 
          Germany, France, Spain, Italy, Russia, 
          SouthKorea, Brazil, Australia, Canada, India
        ]
      fail-fast: false  # ä¸å› å•ä¸ªå›½å®¶å¤±è´¥è€Œåœæ­¢å…¶ä»–å›½å®¶

    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: æ¢å¤ä¾èµ–åŒ…å’Œæ„å»º
      run: |
        echo "=== æ„å»ºé¡¹ç›® ==="
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "âœ… æ„å»ºå®Œæˆ"

    - name: æ£€æŸ¥ ${{ matrix.country }} ç°æœ‰æ•°æ®
      run: |
        echo "=== ${{ matrix.country }} ç°æœ‰æ•°æ®æ£€æŸ¥ ==="
        if [ -d "BingWallpaperData/${{ matrix.country }}" ]; then
          echo "âœ… ${{ matrix.country }} ç›®å½•å­˜åœ¨"
          echo "ç°æœ‰æ–‡ä»¶:"
          find BingWallpaperData/${{ matrix.country }} -name "*.json" | head -10
          echo ""
          echo "æ–‡ä»¶æ€»æ•°: $(find BingWallpaperData/${{ matrix.country }} -name "*.json" | wc -l)"
        else
          echo "ğŸ“ ${{ matrix.country }} ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°ç›®å½•"
        fi

    - name: åˆ é™¤ä»Šæ—¥æ•°æ®ï¼ˆå¦‚æœå¼ºåˆ¶è¦†ç›–ï¼‰
      if: github.event.inputs.force_overwrite == 'true'
      run: |
        TODAY=$(date +'%Y-%m-%d')
        echo "=== å¼ºåˆ¶è¦†ç›–æ¨¡å¼ï¼šåˆ é™¤ ${{ matrix.country }} ä»Šæ—¥ ($TODAY) æ•°æ® ==="
        if [ -d "BingWallpaperData/${{ matrix.country }}/$TODAY" ]; then
          rm -rf "BingWallpaperData/${{ matrix.country }}/$TODAY"
          echo "âœ… å·²åˆ é™¤ ${{ matrix.country }}/$TODAY ç›®å½•"
        else
          echo "ğŸ“‚ ${{ matrix.country }}/$TODAY ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
        fi

    - name: æ”¶é›† ${{ matrix.country }} å£çº¸ä¿¡æ¯
      run: |
        echo "=== å¼€å§‹æ”¶é›† ${{ matrix.country }} å£çº¸ä¿¡æ¯ ==="
        dotnet run --configuration Release
        echo "=== ${{ matrix.country }} ç¨‹åºæ‰§è¡Œå®Œæˆ ==="
      env:
        AUTO_MODE: "true"
        COLLECT_ALL_COUNTRIES: "false"
        TARGET_COUNTRY: "${{ matrix.country }}"
        COLLECT_DAYS: "${{ github.event.inputs.collect_days }}"
        CONCURRENT_REQUESTS: "1"
        JSON_FORMAT: "pretty"

    - name: è¯¦ç»†æ£€æŸ¥ ${{ matrix.country }} æ”¶é›†ç»“æœ
      run: |
        echo "=== ${{ matrix.country }} æ”¶é›†ç»“æœè¯¦ç»†æ£€æŸ¥ ==="
        
        if [ -d "BingWallpaperData/${{ matrix.country }}" ]; then
          echo "âœ… ${{ matrix.country }} ç›®å½•å­˜åœ¨"
          
          # æ˜¾ç¤ºæ‰€æœ‰JSONæ–‡ä»¶
          echo "æ‰€æœ‰JSONæ–‡ä»¶:"
          find BingWallpaperData/${{ matrix.country }} -name "*.json" | sort
          
          # æ£€æŸ¥ä»Šæ—¥æ–‡ä»¶
          TODAY=$(date +'%Y-%m-%d')
          if [ -f "BingWallpaperData/${{ matrix.country }}/$TODAY/wallpaper_info.json" ]; then
            echo ""
            echo "âœ… ${{ matrix.country }} ä»Šæ—¥ ($TODAY) æ•°æ®å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < "BingWallpaperData/${{ matrix.country }}/$TODAY/wallpaper_info.json") å­—èŠ‚"
            echo "æ ‡é¢˜é¢„è§ˆ:"
            grep -o '"Title"[^,]*' "BingWallpaperData/${{ matrix.country }}/$TODAY/wallpaper_info.json" || echo "æ— æ³•è·å–æ ‡é¢˜"
          else
            echo ""
            echo "âŒ ${{ matrix.country }} ä»Šæ—¥ ($TODAY) æ•°æ®ä¸å­˜åœ¨"
            echo "å¯èƒ½åŸå› : 1) APIæ— æ•°æ® 2) ç½‘ç»œé—®é¢˜ 3) æ–‡ä»¶å·²å­˜åœ¨è¢«è·³è¿‡"
          fi
          
          echo ""
          echo "æ€»æ–‡ä»¶æ•°: $(find BingWallpaperData/${{ matrix.country }} -name "*.json" | wc -l)"
        else
          echo "âŒ ${{ matrix.country }} ç›®å½•ä¸å­˜åœ¨ - æ”¶é›†å¤±è´¥"
        fi

    - name: æäº¤ ${{ matrix.country }} æ•°æ®ï¼ˆå¦‚æœ‰å˜æ›´ï¼‰
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        echo "=== æ£€æŸ¥ ${{ matrix.country }} Git çŠ¶æ€ ==="
        
        # åªæ£€æŸ¥å½“å‰å›½å®¶çš„å˜æ›´
        CHANGES=$(git status --porcelain "BingWallpaperData/${{ matrix.country }}" 2>/dev/null || echo "")
        
        if [ -n "$CHANGES" ]; then
          echo "âœ… ${{ matrix.country }} å‘ç°ä»¥ä¸‹æ–‡ä»¶å˜æ›´:"
          echo "$CHANGES"
          
          # åªæ·»åŠ å½“å‰å›½å®¶çš„æ–‡ä»¶
          git add "BingWallpaperData/${{ matrix.country }}/"
          echo "å·²æ·»åŠ  ${{ matrix.country }} æ–‡ä»¶åˆ°æš‚å­˜åŒº"
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(echo "$CHANGES" | wc -l)
          
          git commit -m "ğŸŒ æ”¶é›† ${{ matrix.country }} å£çº¸ä¿¡æ¯ - $(date +'%Y-%m-%d %H:%M UTC')" \
                     -m "ğŸ“Š æ›´æ–°äº† ${FILE_COUNT} ä¸ª ${{ matrix.country }} æ–‡ä»¶" \
                     -m "ğŸ¤– å¼ºåˆ¶æ”¶é›†æ¨¡å¼æ‰§è¡Œ"
          echo "å·²åˆ›å»º ${{ matrix.country }} æäº¤"
          
          git push
          echo "âœ… ${{ matrix.country }} æ•°æ®å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"
        else
          echo "â„¹ï¸ ${{ matrix.country }} æ²¡æœ‰å‘ç°æ–‡ä»¶å˜æ›´"
          echo "åŸå› : æ•°æ®å·²å­˜åœ¨æˆ–æ”¶é›†å¤±è´¥"
        fi

    - name: ç”Ÿæˆ ${{ matrix.country }} æ”¶é›†æŠ¥å‘Š
      if: always()
      run: |
        echo "## ğŸ“Š ${{ matrix.country }} æ”¶é›†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**æ”¶é›†å¤©æ•°:** ${{ github.event.inputs.collect_days }}" >> $GITHUB_STEP_SUMMARY
        echo "**å¼ºåˆ¶è¦†ç›–:** ${{ github.event.inputs.force_overwrite }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "BingWallpaperData/${{ matrix.country }}" ]; then
          FILE_COUNT=$(find BingWallpaperData/${{ matrix.country }} -name "*.json" | wc -l)
          echo "âœ… **çŠ¶æ€:** æˆåŠŸ ($FILE_COUNT ä¸ªæ–‡ä»¶)" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ä»Šæ—¥æ•°æ®
          TODAY=$(date +'%Y-%m-%d')
          if [ -f "BingWallpaperData/${{ matrix.country }}/$TODAY/wallpaper_info.json" ]; then
            echo "ğŸ†• **ä»Šæ—¥æ•°æ®:** å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **ä»Šæ—¥æ•°æ®:** ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²æœ‰æˆ–APIæ— æ•°æ®ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **çŠ¶æ€:** å¤±è´¥ - æœªåˆ›å»ºä»»ä½•æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
