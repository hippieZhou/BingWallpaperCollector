name: æµ‹è¯•å£çº¸æ”¶é›†

on:
  workflow_dispatch:
    inputs:
      collection_mode:
        description: "æ”¶é›†æ¨¡å¼"
        required: true
        default: "single_country"
        type: choice
        options:
          - "single_country"
          - "all_countries"
      target_country:
        description: "ç›®æ ‡å›½å®¶ï¼ˆå•å›½å®¶æ¨¡å¼æ—¶ä½¿ç”¨ï¼‰"
        required: false
        default: "China"
        type: choice
        options:
          - "China"
          - "UnitedStates"
          - "UnitedKingdom"
          - "Japan"
          - "Germany"
          - "France"
          - "Spain"
          - "Italy"
          - "Russia"
          - "SouthKorea"
          - "Brazil"
          - "Australia"
          - "Canada"
          - "India"
      collect_days:
        description: "æ”¶é›†å¤©æ•° (1-8)"
        required: false
        default: "1"
        type: string
      json_format:
        description: "JSON æ ¼å¼"
        required: false
        default: "pretty"
        type: choice
        options:
          - "pretty"
          - "compressed"

permissions:
  contents: write

jobs:
  test-collection:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: æ¢å¤ä¾èµ–åŒ…
        run: dotnet restore

      - name: æž„å»ºé¡¹ç›®
        run: dotnet build --configuration Release --no-restore

      - name: æ‰§è¡Œæµ‹è¯•æ”¶é›†
        run: dotnet run --configuration Release
        env:
          AUTO_MODE: "true"
          COLLECT_ALL_COUNTRIES: ${{ github.event.inputs.collection_mode == 'all_countries' }}
          TARGET_COUNTRY: ${{ github.event.inputs.target_country }}
          COLLECT_DAYS: ${{ github.event.inputs.collect_days }}
          CONCURRENT_REQUESTS: "3"
          JSON_FORMAT: ${{ github.event.inputs.json_format }}

      - name: æ£€æŸ¥æ”¶é›†ç»“æžœ
        id: check_results
        run: |
          echo "=== æ”¶é›†ç»“æžœç»Ÿè®¡ ===" 

          TOTAL_FILES=0
          echo "## ðŸ“Š æ”¶é›†ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**æ”¶é›†æ¨¡å¼:** ${{ github.event.inputs.collection_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ ‡å›½å®¶:** ${{ github.event.inputs.target_country }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ”¶é›†å¤©æ•°:** ${{ github.event.inputs.collect_days }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å›½å®¶ | æ–°å¢žæ–‡ä»¶ | æ€»æ–‡ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|---------|" >> $GITHUB_STEP_SUMMARY

          for country_dir in BingWallpaperData/*/; do
            if [ -d "$country_dir" ]; then
              country=$(basename "$country_dir")
              total_files=$(find "$country_dir" -name "wallpaper_info.json" | wc -l)
              new_files=$(git status --porcelain "$country_dir" | wc -l)
              TOTAL_FILES=$((TOTAL_FILES + total_files))
              
              if [ $new_files -gt 0 ]; then
                echo "| $country | âœ… $new_files | $total_files |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $country | - | $total_files |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ€»è®¡:** $TOTAL_FILES ä¸ªå£çº¸ä¿¡æ¯æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY

          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **çŠ¶æ€:** å‘çŽ°æ–°çš„å£çº¸ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ **çŠ¶æ€:** æ²¡æœ‰å‘çŽ°æ–°çš„å£çº¸ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi

      - name: æäº¤æµ‹è¯•ç»“æžœï¼ˆå¯é€‰ï¼‰
        if: steps.check_results.outputs.has_changes == 'true'
        run: |
          echo "å‘çŽ°æ–°æ•°æ®ï¼Œè¯¢é—®æ˜¯å¦æäº¤..."
          echo "è¦æäº¤è¿™äº›æ›´æ”¹ï¼Œè¯·é‡æ–°è¿è¡Œæ­¤ workflow å¹¶ç¡®è®¤ã€‚"
          echo ""
          echo "æ–°æ–‡ä»¶åˆ—è¡¨ï¼š"
          git status --porcelain

          # æš‚æ—¶ä¸è‡ªåŠ¨æäº¤æµ‹è¯•ç»“æžœï¼Œè®©ç”¨æˆ·å†³å®š
          echo "::warning::å‘çŽ°æ–°çš„å£çº¸æ•°æ®ï¼Œä½†æµ‹è¯•æ¨¡å¼ä¸ä¼šè‡ªåŠ¨æäº¤ã€‚å¦‚éœ€ä¿å­˜è¯·æ‰‹åŠ¨å¤„ç†ã€‚"

      - name: æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ç›®å½•ç»“æž„" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find BingWallpaperData -name "*.json" | head -20 >> $GITHUB_STEP_SUMMARY
          if [ $(find BingWallpaperData -name "*.json" | wc -l) -gt 20 ]; then
            echo "... (è¿˜æœ‰æ›´å¤šæ–‡ä»¶)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
