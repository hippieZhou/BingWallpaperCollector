name: æ¯æ—¥æ”¶é›†Bingå£çº¸ä¿¡æ¯

on:
  schedule:
    # æ¯å¤© UTC 00:30 (åŒ—äº¬æ—¶é—´ 08:30) è¿è¡Œï¼Œæ”¶é›†å…¨çƒå„åœ°çš„æœ€æ–°å£çº¸
    - cron: "30 0 * * *"
    # æ¯å¤© UTC 12:30 (åŒ—äº¬æ—¶é—´ 20:30) å†æ¬¡è¿è¡Œï¼Œç¡®ä¿èŽ·å–ä¸åŒæ—¶åŒºçš„æ›´æ–°
    - cron: "30 12 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  collect-wallpapers:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: æ¢å¤ä¾èµ–åŒ…
        run: dotnet restore

      - name: æž„å»ºé¡¹ç›®
        run: dotnet build --configuration Release --no-restore

      - name: æ”¶é›†å…¨çƒå£çº¸ä¿¡æ¯
        run: dotnet run --configuration Release
        env:
          # é…ç½®è‡ªåŠ¨åŒ–è¿è¡Œå‚æ•°
          AUTO_MODE: "true" # å¯ç”¨è‡ªåŠ¨æ¨¡å¼
          COLLECT_ALL_COUNTRIES: "true" # æ”¶é›†æ‰€æœ‰æ”¯æŒçš„å›½å®¶
          COLLECT_DAYS: "1" # æ”¶é›†1å¤©çš„æ•°æ®ï¼ˆä»Šæ—¥ï¼‰
          CONCURRENT_REQUESTS: "3" # å¹¶å‘è¯·æ±‚æ•°
          JSON_FORMAT: "pretty" # ä½¿ç”¨ç¾ŽåŒ–çš„JSONæ ¼å¼

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ•°æ®
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "å‘çŽ°æ–°çš„å£çº¸æ•°æ®"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ–°çš„å£çº¸æ•°æ®"
          fi

      - name: æäº¤å¹¶æŽ¨é€æ–°æ•°æ®
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # æ·»åŠ æ‰€æœ‰æ–°æ–‡ä»¶
          git add BingWallpaperData/

          # èŽ·å–å½“å‰æ—¥æœŸ
          DATE=$(date +'%Y-%m-%d')
          TIME=$(date +'%H:%M UTC')

          # ç»Ÿè®¡æ–°å¢žçš„æ–‡ä»¶æ•°é‡
          NEW_FILES=$(git diff --cached --name-only | wc -l)

          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          git commit -m "ðŸŒ… è‡ªåŠ¨æ”¶é›† ${DATE} çš„ Bing å£çº¸ä¿¡æ¯" \
                    -m "ðŸ“Š æ›´æ–°äº† ${NEW_FILES} ä¸ªæ–‡ä»¶" \
                    -m "â° æ”¶é›†æ—¶é—´: ${TIME}" \
                    -m "ðŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ"

          # æŽ¨é€åˆ°ä»“åº“
          git push

      - name: ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ“Š Bingå£çº¸æ”¶é›†æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **çŠ¶æ€:** æˆåŠŸæ”¶é›†åˆ°æ–°çš„å£çº¸ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            
            # ç»Ÿè®¡å„å›½å®¶çš„æ•°æ®æ–‡ä»¶
            echo "## ðŸ“ˆ æ•°æ®ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| å›½å®¶ | æ–‡ä»¶æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
            
            for country_dir in BingWallpaperData/*/; do
              if [ -d "$country_dir" ]; then
                country=$(basename "$country_dir")
                file_count=$(find "$country_dir" -name "wallpaper_info.json" | wc -l)
                echo "| $country | $file_count |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "â„¹ï¸ **çŠ¶æ€:** æ²¡æœ‰å‘çŽ°æ–°çš„å£çº¸ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´: æ¯å¤© UTC 00:30 å’Œ 12:30*" >> $GITHUB_STEP_SUMMARY
