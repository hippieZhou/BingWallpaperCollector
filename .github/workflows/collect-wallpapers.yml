name: 每日收集Bing壁纸信息

on:
  schedule:
    # 每天 UTC 00:30 (北京时间 08:30) 运行，收集全球各地的最新壁纸
    - cron: "30 0 * * *"
    # 每天 UTC 12:30 (北京时间 20:30) 再次运行，确保获取不同时区的更新
    - cron: "30 12 * * *"
  workflow_dispatch: # 支持手动触发

permissions:
  contents: write
  actions: read

jobs:
  collect-wallpapers:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置 .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: 恢复依赖包
        run: dotnet restore

      - name: 构建项目
        run: dotnet build --configuration Release --no-restore

      - name: 收集全球壁纸信息
        run: dotnet run --configuration Release
        env:
          # 配置自动化运行参数
          AUTO_MODE: "true" # 启用自动模式
          COLLECT_ALL_COUNTRIES: "true" # 收集所有支持的国家
          COLLECT_DAYS: "1" # 收集1天的数据（今日）
          CONCURRENT_REQUESTS: "3" # 并发请求数
          JSON_FORMAT: "pretty" # 使用美化的JSON格式

      - name: 配置 Git 用户信息
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: 检查是否有新的数据
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "发现新的壁纸数据"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "没有新的壁纸数据"
          fi

      - name: 提交并推送新数据
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # 添加所有新文件
          git add BingWallpaperData/

          # 获取当前日期
          DATE=$(date +'%Y-%m-%d')
          TIME=$(date +'%H:%M UTC')

          # 统计新增的文件数量
          NEW_FILES=$(git diff --cached --name-only | wc -l)

          # 创建详细的提交信息
          git commit -m "🌅 自动收集 ${DATE} 的 Bing 壁纸信息" \
                    -m "📊 更新了 ${NEW_FILES} 个文件" \
                    -m "⏰ 收集时间: ${TIME}" \
                    -m "🤖 由 GitHub Actions 自动执行"

          # 推送到仓库
          git push

      - name: 生成摘要报告
        if: always()
        run: |
          echo "## 📊 Bing壁纸收集摘要" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**执行时间:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ **状态:** 成功收集到新的壁纸信息" >> $GITHUB_STEP_SUMMARY
            
            # 统计各国家的数据文件
            echo "## 📈 数据统计" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| 国家 | 文件数量 |" >> $GITHUB_STEP_SUMMARY
            echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
            
            for country_dir in BingWallpaperData/*/; do
              if [ -d "$country_dir" ]; then
                country=$(basename "$country_dir")
                file_count=$(find "$country_dir" -name "wallpaper_info.json" | wc -l)
                echo "| $country | $file_count |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "ℹ️ **状态:** 没有发现新的壁纸信息" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*下次执行时间: 每天 UTC 00:30 和 12:30*" >> $GITHUB_STEP_SUMMARY
