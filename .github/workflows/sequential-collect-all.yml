name: é¡ºåºæ”¶é›†æ‰€æœ‰å›½å®¶å£çº¸ï¼ˆé¿å…å†²çªï¼‰

on:
  workflow_dispatch:
    inputs:
      force_overwrite:
        description: 'å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶'
        required: false
        default: false
        type: boolean
      collect_days:
        description: 'æ”¶é›†å¤©æ•° (1-8)'
        required: false
        default: '1'
        type: string

permissions:
  contents: write
  actions: read

jobs:
  sequential-collect:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: æ¢å¤ä¾èµ–åŒ…å’Œæž„å»º
      run: |
        echo "=== æž„å»ºé¡¹ç›® ==="
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "âœ… æž„å»ºå®Œæˆ"

    - name: åˆå§‹åŒ–æ”¶é›†ç»Ÿè®¡
      run: |
        echo "=== å¼€å§‹é¡ºåºæ”¶é›†æ‰€æœ‰å›½å®¶å£çº¸ä¿¡æ¯ ==="
        echo "æ‰§è¡Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M UTC')"
        echo "å¼ºåˆ¶è¦†ç›–: ${{ github.event.inputs.force_overwrite }}"
        echo "æ”¶é›†å¤©æ•°: ${{ github.event.inputs.collect_days }}"
        echo ""
        
        # åˆ›å»ºç»Ÿè®¡æ–‡ä»¶
        echo "0" > /tmp/success_count
        echo "0" > /tmp/skip_count
        echo "0" > /tmp/fail_count
        echo "" > /tmp/collect_summary

    - name: æ”¶é›† China å£çº¸
      run: |
        COUNTRY="China"
        echo "=== æ”¶é›† $COUNTRY å£çº¸ä¿¡æ¯ ==="
        
        # åˆ é™¤ä»Šæ—¥æ•°æ®ï¼ˆå¦‚æžœå¼ºåˆ¶è¦†ç›–ï¼‰
        if [ "${{ github.event.inputs.force_overwrite }}" == "true" ]; then
          TODAY=$(date +'%Y-%m-%d')
          if [ -d "BingWallpaperData/$COUNTRY/$TODAY" ]; then
            rm -rf "BingWallpaperData/$COUNTRY/$TODAY"
            echo "ðŸ”„ å·²åˆ é™¤ $COUNTRY ä»Šæ—¥æ•°æ®"
          fi
        fi
        
        # æ‰§è¡Œæ”¶é›†
        dotnet run --configuration Release
        
        # æ£€æŸ¥ç»“æžœå¹¶æ›´æ–°ç»Ÿè®¡
        if [ -d "BingWallpaperData/$COUNTRY" ]; then
          FILE_COUNT=$(find "BingWallpaperData/$COUNTRY" -name "*.json" | wc -l)
          echo "âœ… $COUNTRY: $FILE_COUNT ä¸ªæ–‡ä»¶" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/success_count) + 1)) > /tmp/success_count
        else
          echo "âŒ $COUNTRY: æ”¶é›†å¤±è´¥" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/fail_count) + 1)) > /tmp/fail_count
        fi
        echo ""
      env:
        AUTO_MODE: "true"
        COLLECT_ALL_COUNTRIES: "false"
        TARGET_COUNTRY: "China"
        COLLECT_DAYS: "${{ github.event.inputs.collect_days }}"
        CONCURRENT_REQUESTS: "1"
        JSON_FORMAT: "pretty"

    - name: æ”¶é›† UnitedStates å£çº¸
      run: |
        COUNTRY="UnitedStates"
        echo "=== æ”¶é›† $COUNTRY å£çº¸ä¿¡æ¯ ==="
        
        if [ "${{ github.event.inputs.force_overwrite }}" == "true" ]; then
          TODAY=$(date +'%Y-%m-%d')
          if [ -d "BingWallpaperData/$COUNTRY/$TODAY" ]; then
            rm -rf "BingWallpaperData/$COUNTRY/$TODAY"
            echo "ðŸ”„ å·²åˆ é™¤ $COUNTRY ä»Šæ—¥æ•°æ®"
          fi
        fi
        
        dotnet run --configuration Release
        
        if [ -d "BingWallpaperData/$COUNTRY" ]; then
          FILE_COUNT=$(find "BingWallpaperData/$COUNTRY" -name "*.json" | wc -l)
          echo "âœ… $COUNTRY: $FILE_COUNT ä¸ªæ–‡ä»¶" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/success_count) + 1)) > /tmp/success_count
        else
          echo "âŒ $COUNTRY: æ”¶é›†å¤±è´¥" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/fail_count) + 1)) > /tmp/fail_count
        fi
        echo ""
      env:
        AUTO_MODE: "true"
        COLLECT_ALL_COUNTRIES: "false"
        TARGET_COUNTRY: "UnitedStates"
        COLLECT_DAYS: "${{ github.event.inputs.collect_days }}"
        CONCURRENT_REQUESTS: "1"
        JSON_FORMAT: "pretty"

    - name: æ”¶é›† UnitedKingdom å£çº¸
      run: |
        COUNTRY="UnitedKingdom"
        echo "=== æ”¶é›† $COUNTRY å£çº¸ä¿¡æ¯ ==="
        
        if [ "${{ github.event.inputs.force_overwrite }}" == "true" ]; then
          TODAY=$(date +'%Y-%m-%d')
          if [ -d "BingWallpaperData/$COUNTRY/$TODAY" ]; then
            rm -rf "BingWallpaperData/$COUNTRY/$TODAY"
            echo "ðŸ”„ å·²åˆ é™¤ $COUNTRY ä»Šæ—¥æ•°æ®"
          fi
        fi
        
        dotnet run --configuration Release
        
        if [ -d "BingWallpaperData/$COUNTRY" ]; then
          FILE_COUNT=$(find "BingWallpaperData/$COUNTRY" -name "*.json" | wc -l)
          echo "âœ… $COUNTRY: $FILE_COUNT ä¸ªæ–‡ä»¶" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/success_count) + 1)) > /tmp/success_count
        else
          echo "âŒ $COUNTRY: æ”¶é›†å¤±è´¥" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/fail_count) + 1)) > /tmp/fail_count
        fi
        echo ""
      env:
        AUTO_MODE: "true"
        COLLECT_ALL_COUNTRIES: "false"
        TARGET_COUNTRY: "UnitedKingdom"
        COLLECT_DAYS: "${{ github.event.inputs.collect_days }}"
        CONCURRENT_REQUESTS: "1"
        JSON_FORMAT: "pretty"

    - name: æ”¶é›† Japan å£çº¸
      run: |
        COUNTRY="Japan"
        echo "=== æ”¶é›† $COUNTRY å£çº¸ä¿¡æ¯ ==="
        
        if [ "${{ github.event.inputs.force_overwrite }}" == "true" ]; then
          TODAY=$(date +'%Y-%m-%d')
          if [ -d "BingWallpaperData/$COUNTRY/$TODAY" ]; then
            rm -rf "BingWallpaperData/$COUNTRY/$TODAY"
            echo "ðŸ”„ å·²åˆ é™¤ $COUNTRY ä»Šæ—¥æ•°æ®"
          fi
        fi
        
        dotnet run --configuration Release
        
        if [ -d "BingWallpaperData/$COUNTRY" ]; then
          FILE_COUNT=$(find "BingWallpaperData/$COUNTRY" -name "*.json" | wc -l)
          echo "âœ… $COUNTRY: $FILE_COUNT ä¸ªæ–‡ä»¶" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/success_count) + 1)) > /tmp/success_count
        else
          echo "âŒ $COUNTRY: æ”¶é›†å¤±è´¥" | tee -a /tmp/collect_summary
          echo $(($(cat /tmp/fail_count) + 1)) > /tmp/fail_count
        fi
        echo ""
      env:
        AUTO_MODE: "true"
        COLLECT_ALL_COUNTRIES: "false"
        TARGET_COUNTRY: "Japan"
        COLLECT_DAYS: "${{ github.event.inputs.collect_days }}"
        CONCURRENT_REQUESTS: "1"
        JSON_FORMAT: "pretty"

    - name: æ”¶é›†å…¶ä½™å›½å®¶å£çº¸
      run: |
        COUNTRIES=("Germany" "France" "Spain" "Italy" "Russia" "SouthKorea" "Brazil" "Australia" "Canada" "India")
        
        for COUNTRY in "${COUNTRIES[@]}"; do
          echo "=== æ”¶é›† $COUNTRY å£çº¸ä¿¡æ¯ ==="
          
          if [ "${{ github.event.inputs.force_overwrite }}" == "true" ]; then
            TODAY=$(date +'%Y-%m-%d')
            if [ -d "BingWallpaperData/$COUNTRY/$TODAY" ]; then
              rm -rf "BingWallpaperData/$COUNTRY/$TODAY"
              echo "ðŸ”„ å·²åˆ é™¤ $COUNTRY ä»Šæ—¥æ•°æ®"
            fi
          fi
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡å¹¶æ‰§è¡Œæ”¶é›†
          export AUTO_MODE="true"
          export COLLECT_ALL_COUNTRIES="false"
          export TARGET_COUNTRY="$COUNTRY"
          export COLLECT_DAYS="${{ github.event.inputs.collect_days }}"
          export CONCURRENT_REQUESTS="1"
          export JSON_FORMAT="pretty"
          
          dotnet run --configuration Release
          
          # æ£€æŸ¥æ”¶é›†ç»“æžœ
          if [ -d "BingWallpaperData/$COUNTRY" ]; then
            FILE_COUNT=$(find "BingWallpaperData/$COUNTRY" -name "*.json" | wc -l)
            echo "âœ… $COUNTRY: $FILE_COUNT ä¸ªæ–‡ä»¶" | tee -a /tmp/collect_summary
            echo $(($(cat /tmp/success_count) + 1)) > /tmp/success_count
          else
            echo "âŒ $COUNTRY: æ”¶é›†å¤±è´¥" | tee -a /tmp/collect_summary
            echo $(($(cat /tmp/fail_count) + 1)) > /tmp/fail_count
          fi
          echo ""
          
          # æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIè¯·æ±‚è¿‡äºŽé¢‘ç¹
          sleep 2
        done

    - name: ç»Ÿä¸€æäº¤æ‰€æœ‰æ”¶é›†ç»“æžœ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        echo "=== æ£€æŸ¥æ”¶é›†ç»“æžœå¹¶å‡†å¤‡æäº¤ ==="
        
        # è¯»å–ç»Ÿè®¡ä¿¡æ¯
        SUCCESS_COUNT=$(cat /tmp/success_count)
        FAIL_COUNT=$(cat /tmp/fail_count)
        TOTAL_COUNT=$((SUCCESS_COUNT + FAIL_COUNT))
        
        echo "æ”¶é›†ç»Ÿè®¡ï¼š"
        echo "- æˆåŠŸ: $SUCCESS_COUNT ä¸ªå›½å®¶"
        echo "- å¤±è´¥: $FAIL_COUNT ä¸ªå›½å®¶"
        echo "- æ€»è®¡: $TOTAL_COUNT ä¸ªå›½å®¶"
        echo ""
        echo "è¯¦ç»†ç»“æžœï¼š"
        cat /tmp/collect_summary
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        CHANGES=$(git status --porcelain BingWallpaperData/ 2>/dev/null || echo "")
        
        if [ -n "$CHANGES" ]; then
          echo ""
          echo "âœ… å‘çŽ°ä»¥ä¸‹æ–‡ä»¶å˜æ›´:"
          echo "$CHANGES"
          echo ""
          
          # ç»Ÿè®¡å˜æ›´æ–‡ä»¶æ•°é‡
          FILE_CHANGE_COUNT=$(echo "$CHANGES" | wc -l)
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add BingWallpaperData/
          echo "å·²æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶åˆ°æš‚å­˜åŒº"
          
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          git commit -m "ðŸŒ æ‰¹é‡æ”¶é›†å¤šå›½å£çº¸ä¿¡æ¯ - $(date +'%Y-%m-%d %H:%M UTC')" \
                     -m "ðŸ“Š ç»Ÿè®¡ç»“æžœ:" \
                     -m "  - æˆåŠŸæ”¶é›†: $SUCCESS_COUNT ä¸ªå›½å®¶" \
                     -m "  - æ–‡ä»¶å˜æ›´: $FILE_CHANGE_COUNT ä¸ª" \
                     -m "  - å¼ºåˆ¶è¦†ç›–: ${{ github.event.inputs.force_overwrite }}" \
                     -m "  - æ”¶é›†å¤©æ•°: ${{ github.event.inputs.collect_days }}" \
                     -m "" \
                     -m "ðŸ¤– é¡ºåºæ”¶é›†æ¨¡å¼æ‰§è¡Œ"
          
          echo "å·²åˆ›å»ºæäº¤"
          
          # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin main
          echo "âœ… æ‰€æœ‰æ•°æ®å·²æŽ¨é€åˆ°è¿œç¨‹ä»“åº“"
        else
          echo "â„¹ï¸ æ²¡æœ‰å‘çŽ°æ–‡ä»¶å˜æ›´"
          echo "æ‰€æœ‰å›½å®¶çš„æ•°æ®å¯èƒ½éƒ½å·²å­˜åœ¨ï¼Œæˆ–è€…æ”¶é›†éƒ½å¤±è´¥äº†"
        fi

    - name: ç”Ÿæˆå®Œæ•´æ”¶é›†æŠ¥å‘Š
      if: always()
      run: |
        SUCCESS_COUNT=$(cat /tmp/success_count)
        FAIL_COUNT=$(cat /tmp/fail_count)
        TOTAL_COUNT=$((SUCCESS_COUNT + FAIL_COUNT))
        
        echo "## ðŸŒ æ‰¹é‡æ”¶é›†å®Œæ•´æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ¨¡å¼:** é¡ºåºæ”¶é›†ï¼ˆé¿å…å¹¶å‘å†²çªï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "**å¼ºåˆ¶è¦†ç›–:** ${{ github.event.inputs.force_overwrite }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ”¶é›†å¤©æ•°:** ${{ github.event.inputs.collect_days }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š ç»Ÿè®¡ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **æˆåŠŸ:** $SUCCESS_COUNT ä¸ªå›½å®¶" >> $GITHUB_STEP_SUMMARY
        echo "- âŒ **å¤±è´¥:** $FAIL_COUNT ä¸ªå›½å®¶" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ˆ **æ€»è®¡:** $TOTAL_COUNT ä¸ªå›½å®¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ è¯¦ç»†ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat /tmp/collect_summary >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # æ˜¾ç¤ºç›®å½•ç»“æž„
        if [ -d "BingWallpaperData" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æ”¶é›†åˆ°çš„æ•°æ®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find BingWallpaperData -name "*.json" | sort >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
