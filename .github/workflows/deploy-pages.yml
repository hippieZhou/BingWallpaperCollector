name: éƒ¨ç½²åˆ° GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'BingWallpaperData/**'
      - '.github/workflows/deploy-pages.yml'
  
  # å®šæ—¶æ‰§è¡Œ - æ¯å¤© UTC 2:00 (åŒ—äº¬æ—¶é—´ 10:00)
  schedule:
    - cron: '0 2 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æž„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Copy data to docs directory
        run: |
          # å°†BingWallpaperDataå¤åˆ¶åˆ°docsç›®å½•ï¼Œä½¿å…¶å¯åœ¨GitHub Pagesä¸­è®¿é—®
          if [ -d "BingWallpaperData" ]; then
            cp -r BingWallpaperData docs/
            echo "âœ… æ•°æ®æ–‡ä»¶å·²å¤åˆ¶åˆ°docsç›®å½•"
            
            # éªŒè¯å¤åˆ¶ç»“æžœ
            echo "ðŸ“Š å¤åˆ¶ç»Ÿè®¡:"
            echo "  - å›½å®¶ç›®å½•æ•°: $(ls docs/BingWallpaperData | wc -l)"
            echo "  - JSONæ–‡ä»¶æ€»æ•°: $(find docs/BingWallpaperData -name '*.json' | wc -l)"
            echo "  - æ€»æ–‡ä»¶å¤§å°: $(du -sh docs/BingWallpaperData | cut -f1)"
            
            # æ˜¾ç¤ºç¤ºä¾‹æ–‡ä»¶
            echo -e "\nðŸ“ ç›®å½•ç»“æž„ç¤ºä¾‹:"
            ls -la docs/BingWallpaperData | head -5
            
            if [ -f "docs/BingWallpaperData/China/2025-08-28/wallpaper_info.json" ]; then
              echo "âœ… æµ‹è¯•æ–‡ä»¶å­˜åœ¨: China/2025-08-28/wallpaper_info.json"
            else
              echo "âš ï¸ æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨: China/2025-08-28/wallpaper_info.json"
            fi
          else
            echo "âŒ é”™è¯¯: BingWallpaperData ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Create data index
        run: |
          # åˆ›å»ºæ•°æ®ç´¢å¼•æ–‡ä»¶
          cat > docs/data-index.js << 'EOF'
          // è‡ªåŠ¨ç”Ÿæˆçš„æ•°æ®ç´¢å¼•
          window.WALLPAPER_DATA_INDEX = {
            generated: new Date().toISOString(),
            countries: [],
            dates: [],
            totalFiles: 0,
            availableData: {}
          };
          
          // æ‰«æå¯ç”¨æ•°æ®
          const fs = require('fs');
          const path = require('path');
          
          const dataDir = path.join(__dirname, '..', 'BingWallpaperData');
          const index = window.WALLPAPER_DATA_INDEX;
          
          if (fs.existsSync(dataDir)) {
            const countries = fs.readdirSync(dataDir).filter(item => 
              fs.statSync(path.join(dataDir, item)).isDirectory()
            );
            
            countries.forEach(country => {
              const countryPath = path.join(dataDir, country);
              const dates = fs.readdirSync(countryPath).filter(item =>
                fs.statSync(path.join(countryPath, item)).isDirectory()
              );
              
              if (!index.availableData[country]) {
                index.availableData[country] = [];
              }
              
              dates.forEach(date => {
                const jsonFile = path.join(countryPath, date, 'wallpaper_info.json');
                if (fs.existsSync(jsonFile)) {
                  index.availableData[country].push(date);
                  index.totalFiles++;
                }
              });
              
              if (index.availableData[country].length > 0) {
                index.countries.push(country);
                index.dates = [...new Set([...index.dates, ...index.availableData[country]])];
              }
            });
            
            index.dates.sort().reverse();
          }
          EOF
          
          # ä½¿ç”¨Node.jsç”Ÿæˆå®žé™…çš„ç´¢å¼•
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          console.log('ðŸ” å¼€å§‹ç”Ÿæˆæ•°æ®ç´¢å¼•...');
          
          const index = {
            generated: new Date().toISOString(),
            countries: [],
            dates: [],
            totalFiles: 0,
            availableData: {}
          };
          
          const dataDir = 'docs/BingWallpaperData';
          
          if (fs.existsSync(dataDir)) {
            console.log('ðŸ“ æ‰«ææ•°æ®ç›®å½•:', dataDir);
            const countries = fs.readdirSync(dataDir).filter(item => 
              fs.statSync(path.join(dataDir, item)).isDirectory()
            );
            
            console.log('ðŸŒ å‘çŽ°å›½å®¶ç›®å½•:', countries.length, 'ä¸ª');
            
            countries.forEach(country => {
              const countryPath = path.join(dataDir, country);
              if (!fs.existsSync(countryPath)) return;
              
              const dates = fs.readdirSync(countryPath).filter(item =>
                fs.statSync(path.join(countryPath, item)).isDirectory() &&
                /^\d{4}-\d{2}-\d{2}$/.test(item)
              );
              
              if (!index.availableData[country]) {
                index.availableData[country] = [];
              }
              
              dates.forEach(date => {
                const jsonFile = path.join(countryPath, date, 'wallpaper_info.json');
                if (fs.existsSync(jsonFile)) {
                  index.availableData[country].push(date);
                  index.totalFiles++;
                  console.log('âœ… å‘çŽ°æ•°æ®æ–‡ä»¶:', country + '/' + date);
                }
              });
              
              if (index.availableData[country].length > 0) {
                index.countries.push(country);
                index.dates = [...new Set([...index.dates, ...index.availableData[country]])];
              }
            });
            
            // æŒ‰æ—¥æœŸå€’åºæŽ’åˆ—ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
            index.dates.sort().reverse();
            
            // ç”Ÿæˆç´¢å¼•å†…å®¹
            const indexContent = [
              '// è‡ªåŠ¨ç”Ÿæˆçš„æ•°æ®ç´¢å¼•æ–‡ä»¶',
              '// ç”Ÿæˆæ—¶é—´: ' + new Date().toISOString(),
              '',
              'window.WALLPAPER_DATA_INDEX = ' + JSON.stringify(index, null, 2) + ';',
              '',
              'console.log(\"ðŸ“Š æ•°æ®ç´¢å¼•åŠ è½½å®Œæˆ:\", {',
              '  countries: ' + index.countries.length + ',',
              '  dates: ' + index.dates.length + ',',
              '  totalFiles: ' + index.totalFiles,
              '});'
            ].join('\n');
            
            fs.writeFileSync('docs/data-index.js', indexContent);
            
            console.log('âœ… æ•°æ®ç´¢å¼•ç”Ÿæˆå®Œæˆ:');
            console.log('  - å¯ç”¨å›½å®¶:', index.countries.length, 'ä¸ª');
            console.log('  - å¯ç”¨æ—¥æœŸ:', index.dates.length, 'ä¸ª');
            console.log('  - JSONæ–‡ä»¶æ€»æ•°:', index.totalFiles, 'ä¸ª');
            if (index.dates.length > 0) {
              console.log('  - æ—¥æœŸèŒƒå›´:', index.dates[index.dates.length-1], 'è‡³', index.dates[0]);
            }
            console.log('  - ç´¢å¼•æ–‡ä»¶å¤§å°:', fs.statSync('docs/data-index.js').size, 'å­—èŠ‚');
            
            // éªŒè¯ç´¢å¼•æ–‡ä»¶å†…å®¹
            const indexFileContent = fs.readFileSync('docs/data-index.js', 'utf8');
            if (indexFileContent.includes('WALLPAPER_DATA_INDEX')) {
              console.log('âœ… ç´¢å¼•æ–‡ä»¶å†…å®¹éªŒè¯é€šè¿‡');
            } else {
              console.log('âŒ ç´¢å¼•æ–‡ä»¶å†…å®¹éªŒè¯å¤±è´¥');
              process.exit(1);
            }
            
            // è¾“å‡ºå®Œæ•´çš„æ—¥æœŸåˆ—è¡¨ç”¨äºŽè°ƒè¯•
            console.log('ðŸ“… å®Œæ•´æ—¥æœŸåˆ—è¡¨:', JSON.stringify(index.dates));
          } else {
            console.log('âŒ é”™è¯¯: æ•°æ®ç›®å½•ä¸å­˜åœ¨:', dataDir);
            process.exit(1);
          }
          "

      - name: Optimize images and create thumbnails
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ å›¾ç‰‡ä¼˜åŒ–é€»è¾‘ï¼ˆå¯é€‰ï¼‰
          echo "å›¾ç‰‡ä¼˜åŒ–æ­¥éª¤ï¼ˆå½“å‰è·³è¿‡ï¼‰"

      - name: Validate website
        run: |
          # éªŒè¯HTMLå’ŒJSONæ–‡ä»¶
          echo "éªŒè¯ç½‘ç«™æ–‡ä»¶..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "ðŸ” éªŒè¯å…³é”®æ–‡ä»¶..."
          test -f docs/index.html || (echo "âŒ é”™è¯¯: index.html ä¸å­˜åœ¨" && exit 1)
          test -f docs/assets/css/style.css || (echo "âŒ é”™è¯¯: style.css ä¸å­˜åœ¨" && exit 1)
          test -f docs/assets/js/app.js || (echo "âŒ é”™è¯¯: app.js ä¸å­˜åœ¨" && exit 1)
          test -f docs/data-index.js || (echo "âŒ é”™è¯¯: data-index.js ä¸å­˜åœ¨" && exit 1)
          test -d docs/BingWallpaperData || (echo "âŒ é”™è¯¯: BingWallpaperData ç›®å½•ä¸å­˜åœ¨" && exit 1)
          
          echo "âœ… å…³é”®æ–‡ä»¶éªŒè¯é€šè¿‡"
          
          # æ˜¾ç¤ºæœ€ç»ˆçš„æ–‡ä»¶ç»“æž„
          echo -e "\nðŸ“ æœ€ç»ˆéƒ¨ç½²ç»“æž„:"
          find docs -type f | head -20 | sort
          
          # éªŒè¯JSONæ–‡ä»¶æ ¼å¼
          echo "éªŒè¯ JSON æ–‡ä»¶æ ¼å¼..."
          find docs/BingWallpaperData -name "*.json" -exec node -e "
            try {
              JSON.parse(require('fs').readFileSync('{}', 'utf8'));
              console.log('âœ“ {}');
            } catch(e) {
              console.error('âœ— {}: ' + e.message);
              process.exit(1);
            }
          " \;
          
          echo "éªŒè¯é€šè¿‡ï¼"

      - name: Build with Jekyll
        run: |
          # ä¸ºäº†å…¼å®¹GitHub Pagesï¼Œæ·»åŠ Jekyllé…ç½®
          cat > docs/_config.yml << 'EOF'
          # GitHub Pages Jekyll é…ç½®
          title: "å¿…åº”å£çº¸å±•ç¤ºå¹³å°"
          description: "æµè§ˆæ¥è‡ªå…¨çƒ14ä¸ªå›½å®¶/åœ°åŒºçš„ç²¾ç¾Žå¿…åº”å£çº¸"
          baseurl: "/BingWallpaperCollector"
          url: "https://hippiezhou.github.io"
          
          # æŽ’é™¤æ–‡ä»¶
          exclude:
            - node_modules
            - package*.json
            - "*.md"
          
          # åŒ…å«éšè—æ–‡ä»¶
          include:
            - _headers
            - _redirects
          
          # æ’ä»¶
          plugins:
            - jekyll-relative-links
          
          # ç›¸å¯¹é“¾æŽ¥
          relative_links:
            enabled: true
            collections: true
          EOF
          
          # åˆ›å»º.nojekyllæ–‡ä»¶ä»¥ç¦ç”¨Jekyllï¼ˆå¦‚æžœéœ€è¦çº¯é™æ€ç«™ç‚¹ï¼‰
          # touch docs/.nojekyll

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  # éƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # é€šçŸ¥ä½œä¸šï¼ˆå¯é€‰ï¼‰
  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ!"
            echo "ðŸŒ è®¿é—®åœ°å€: https://hippiezhou.github.io/BingWallpaperCollector/"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥!"
          fi
