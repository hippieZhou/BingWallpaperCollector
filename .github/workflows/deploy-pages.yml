name: éƒ¨ç½²åˆ° GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - "page/**"
      - "archive/**"
      - "archive/**/*.json"
      - ".github/workflows/deploy-pages.yml"
  
  # å®šæ—¶æ‰§è¡Œ - æ¯å¤© UTC 2:00 (åŒ—äº¬æ—¶é—´ 10:00)
  schedule:
    - cron: "0 2 * * *"

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write # éœ€è¦å†™æƒé™æ¥æäº¤æ•°æ®ç´¢å¼•æ›´æ–°
  pages: write
  id-token: write

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æž„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: âš™ï¸ é…ç½® Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“‚ å¤åˆ¶æ•°æ®åˆ°é¡µé¢ç›®å½•
        run: |
          # å°†archiveå¤åˆ¶åˆ°pageç›®å½•ï¼Œä½¿å…¶å¯åœ¨GitHub Pagesä¸­è®¿é—®
          if [ -d "archive" ]; then
            cp -r archive page/
            echo "âœ… æ•°æ®æ–‡ä»¶å·²å¤åˆ¶åˆ°pageç›®å½•"
            
            # éªŒè¯å¤åˆ¶ç»“æžœ
            echo "ðŸ“Š å¤åˆ¶ç»Ÿè®¡:"
            echo "  - å›½å®¶ç›®å½•æ•°: $(ls page/archive | wc -l)"
            echo "  - JSONæ–‡ä»¶æ€»æ•°: $(find page/archive -name '*.json' | wc -l)"
            echo "  - æ€»æ–‡ä»¶å¤§å°: $(du -sh page/archive | cut -f1)"
            
            # æ˜¾ç¤ºç¤ºä¾‹æ–‡ä»¶
            echo -e "\nðŸ“ ç›®å½•ç»“æž„ç¤ºä¾‹:"
            ls -la page/archive | head -5
            
            if [ -f "page/archive/China/2025-08-28.json" ]; then
              echo "âœ… æµ‹è¯•æ–‡ä»¶å­˜åœ¨: China/2025-08-28.json"
            else
              echo "âš ï¸ æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨: China/2025-08-28.json"
            fi
          else
            echo "âŒ é”™è¯¯: archive ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ðŸ“Š æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€
        run: |
          echo "=== Archive ç›®å½•çŠ¶æ€æ£€æŸ¥ ==="
          if [ -d archive ]; then
            echo "âœ… archive ç›®å½•å­˜åœ¨"
            echo "ðŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
            find archive -name "*.json" | wc -l | xargs echo "  - JSONæ–‡ä»¶æ€»æ•°:"
            ls -la archive/ | grep -E '^d' | wc -l | xargs echo "  - å›½å®¶ç›®å½•æ•°:"
            echo "  - ç›®å½•å¤§å°: $(du -sh archive | cut -f1)"
          else
            echo "âŒ archive ç›®å½•ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi

          echo ""
          echo "=== å„å›½æœ€æ–°æ•°æ®æ–‡ä»¶ ==="
          for country in archive/*/; do
            if [ -d "$country" ]; then
              country_name=$(basename "$country")
              file_count=$(find "$country" -name "*.json" | wc -l)
              latest_file=$(ls -1t "$country"*.json 2>/dev/null | head -1)
              if [ -n "$latest_file" ]; then
                echo "$country_name: $(basename "$latest_file") (å…±$file_countä¸ªæ–‡ä»¶)"
              else
                echo "$country_name: æ— æ•°æ®æ–‡ä»¶"
              fi
            fi
          done

          echo ""
          echo "=== éªŒè¯æ•°æ®æ–‡ä»¶å†…å®¹ ==="
          # æ£€æŸ¥ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶çš„å†…å®¹
          sample_file=$(find archive -name "*.json" | head -1)
          if [ -n "$sample_file" ]; then
            echo "ç¤ºä¾‹æ–‡ä»¶: $sample_file"
            echo "æ–‡ä»¶å¤§å°: $(wc -c "$sample_file" | cut -d' ' -f1) å­—èŠ‚"
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            head -10 "$sample_file" || echo "æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹"
          fi

          echo ""
          echo "=== å½“å‰ data-index.js çŠ¶æ€ ==="
          if [ -f "page/data-index.js" ]; then
            echo "âœ… page/data-index.js å·²å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(wc -c page/data-index.js | cut -d' ' -f1) å­—èŠ‚"
            # æå–ç”Ÿæˆæ—¶é—´
            grep -o "generated.*" page/data-index.js | head -1 || echo "æœªæ‰¾åˆ°ç”Ÿæˆæ—¶é—´ä¿¡æ¯"
          else
            echo "âŒ page/data-index.js ä¸å­˜åœ¨"
          fi

      - name: ðŸ“ ç”Ÿæˆæ•°æ®ç´¢å¼•
        run: |
          echo "ðŸš€ å¼€å§‹ç”Ÿæˆæ•°æ®ç´¢å¼•..."
          
          # æ£€æŸ¥å¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
          echo "=== çŽ¯å¢ƒæ£€æŸ¥ ==="
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "scriptsç›®å½•æ˜¯å¦å­˜åœ¨: $(test -d scripts && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"
          echo "archiveç›®å½•æ˜¯å¦å­˜åœ¨: $(test -d archive && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"
          
          if [ -d scripts ]; then
            echo "scriptsç›®å½•å†…å®¹:"
            ls -la scripts/
          fi
          
          if [ -d archive ]; then
            echo "archiveç›®å½•å†…å®¹:"
            ls -la archive/ | head -5
            echo "archiveä¸­JSONæ–‡ä»¶æ€»æ•°: $(find archive -name '*.json' | wc -l)"
          else
            echo "âŒ é”™è¯¯: archive ç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæ•°æ®ç´¢å¼•"
            exit 1
          fi
          
          # æ£€æŸ¥ç”Ÿæˆè„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "scripts/generate-data-index.js" ]; then
            echo "âŒ é”™è¯¯: scripts/generate-data-index.js ä¸å­˜åœ¨"
            echo "å°è¯•åˆ—å‡ºæ‰€æœ‰.jsæ–‡ä»¶:"
            find . -name "*.js" | grep -E "(generate|index)" || echo "æœªæ‰¾åˆ°ç›¸å…³è„šæœ¬"
            exit 1
          fi
          
          # è¿è¡Œæ•°æ®ç´¢å¼•ç”Ÿæˆè„šæœ¬
          echo "ðŸš€ æ‰§è¡Œæ•°æ®ç´¢å¼•ç”Ÿæˆ..."
          node scripts/generate-data-index.js
          
          # éªŒè¯ç”Ÿæˆç»“æžœ
          echo ""
          echo "=== éªŒè¯ç”Ÿæˆç»“æžœ ==="
          if [ -f "page/data-index.js" ]; then
            echo "âœ… data-index.js ç”ŸæˆæˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°: $(wc -c page/data-index.js | cut -d' ' -f1) å­—èŠ‚"
            echo ""
            echo "=== ç”Ÿæˆçš„æ–‡ä»¶é¢„è§ˆ ==="
            head -30 page/data-index.js
            echo ""
            echo "=== æ–‡ä»¶æœ«å°¾ ==="
            tail -10 page/data-index.js
          else
            echo "âŒ é”™è¯¯: data-index.js æœªç”Ÿæˆ"
            echo "æ£€æŸ¥pageç›®å½•å†…å®¹:"
            ls -la page/ | head -10
            exit 1
          fi

      - name: ðŸ” æ£€æŸ¥å¹¶æäº¤æ•°æ®ç´¢å¼•æ›´æ–°
        id: check-and-commit
        run: |
          # æ£€æŸ¥ data-index.js æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet page/data-index.js; then
            echo "No changes detected in data-index.js"
            echo "has-index-changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in data-index.js, committing updates..."
            echo "has-index-changes=true" >> $GITHUB_OUTPUT
            
            # é…ç½® Git
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # æ·»åŠ æ›´æ”¹
            git add page/data-index.js
            
            # åˆ›å»ºæäº¤ä¿¡æ¯
            COMMIT_MSG="ðŸ¤– Auto-update data index - $(date '+%Y-%m-%d %H:%M UTC')"
            git commit -m "$COMMIT_MSG"
            
            # æŽ¨é€æ›´æ”¹
            git push
            
            echo "âœ… Data index changes committed and pushed successfully"
            
            echo ""
            echo "=== Changes preview ==="
            git --no-pager show --name-only HEAD
          fi

      - name: ðŸ–¼ï¸ ä¼˜åŒ–å›¾ç‰‡å’Œåˆ›å»ºç¼©ç•¥å›¾
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ å›¾ç‰‡ä¼˜åŒ–é€»è¾‘ï¼ˆå¯é€‰ï¼‰
          echo "å›¾ç‰‡ä¼˜åŒ–æ­¥éª¤ï¼ˆå½“å‰è·³è¿‡ï¼‰"

      - name: âœ… éªŒè¯ç½‘ç«™æ–‡ä»¶
        run: |
          # éªŒè¯HTMLå’ŒJSONæ–‡ä»¶
          echo "éªŒè¯ç½‘ç«™æ–‡ä»¶..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "ðŸ” éªŒè¯å…³é”®æ–‡ä»¶..."
          test -f page/index.html || (echo "âŒ é”™è¯¯: index.html ä¸å­˜åœ¨" && exit 1)
          test -f page/assets/css/style.css || (echo "âŒ é”™è¯¯: style.css ä¸å­˜åœ¨" && exit 1)
          test -f page/assets/js/app.js || (echo "âŒ é”™è¯¯: app.js ä¸å­˜åœ¨" && exit 1)
          test -f page/data-index.js || (echo "âŒ é”™è¯¯: data-index.js ä¸å­˜åœ¨" && exit 1)
          test -d page/archive || (echo "âŒ é”™è¯¯: archive ç›®å½•ä¸å­˜åœ¨" && exit 1)
          
          echo "âœ… å…³é”®æ–‡ä»¶éªŒè¯é€šè¿‡"
          
          # æ˜¾ç¤ºæœ€ç»ˆçš„æ–‡ä»¶ç»“æž„
          echo -e "\nðŸ“ æœ€ç»ˆéƒ¨ç½²ç»“æž„:"
          find page -type f | head -20 | sort
          
          # éªŒè¯JSONæ–‡ä»¶æ ¼å¼
          echo "éªŒè¯ JSON æ–‡ä»¶æ ¼å¼..."
          find page/archive -name "*.json" -exec node -e "
            try {
              JSON.parse(require('fs').readFileSync('{}', 'utf8'));
              console.log('âœ“ {}');
            } catch(e) {
              console.error('âœ— {}: ' + e.message);
              process.exit(1);
            }
          " \;
          
          echo "éªŒè¯é€šè¿‡ï¼"

      - name: ðŸ—ï¸ ä½¿ç”¨ Jekyll æž„å»º
        run: |
          # ä¸ºäº†å…¼å®¹GitHub Pagesï¼Œæ·»åŠ Jekyllé…ç½®
          cat > page/_config.yml << 'EOF'
          # GitHub Pages Jekyll é…ç½®
          title: "å¿…åº”å£çº¸å±•ç¤ºå¹³å°"
          description: "æµè§ˆæ¥è‡ªå…¨çƒ14ä¸ªå›½å®¶/åœ°åŒºçš„ç²¾ç¾Žå¿…åº”å£çº¸"
          baseurl: "/BingWallpaperCollector"
          url: "https://hippiezhou.github.io"
          
          # æŽ’é™¤æ–‡ä»¶
          exclude:
            - node_modules
            - package*.json
            - "*.md"
          
          # åŒ…å«éšè—æ–‡ä»¶
          include:
            - _headers
            - _redirects
          
          # æ’ä»¶
          plugins:
            - jekyll-relative-links
          
          # ç›¸å¯¹é“¾æŽ¥
          relative_links:
            enabled: true
            collections: true
          EOF
          
          # åˆ›å»º.nojekyllæ–‡ä»¶ä»¥ç¦ç”¨Jekyllï¼ˆå¦‚æžœéœ€è¦çº¯é™æ€ç«™ç‚¹ï¼‰
          # touch page/.nojekyll

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./page

  # éƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # é€šçŸ¥ä½œä¸šï¼ˆå¯é€‰ï¼‰
  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    steps:
      - name: ðŸ“¢ é€šçŸ¥éƒ¨ç½²çŠ¶æ€
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ!"
            echo "ðŸŒ è®¿é—®åœ°å€: https://hippiezhou.github.io/BingWallpaperCollector/"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥!"
          fi
