<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç«™å¥åº·æ£€æŸ¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: #f8f9fa;
        }

        .health-card {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 1rem;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
        }

        pre {
            background: #f1f3f4;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .metric {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>ğŸ“‹ ç½‘ç«™å¥åº·æ£€æŸ¥</h1>

    <div class="health-card">
        <h2>ğŸŒ ç¯å¢ƒä¿¡æ¯</h2>
        <div class="grid">
            <div class="metric">
                <div class="metric-number" id="env-type">-</div>
                <div class="metric-label">ç¯å¢ƒç±»å‹</div>
            </div>
            <div class="metric">
                <div class="metric-number" id="base-path">-</div>
                <div class="metric-label">åŸºç¡€è·¯å¾„</div>
            </div>
            <div class="metric">
                <div class="metric-number" id="current-time">-</div>
                <div class="metric-label">å½“å‰æ—¶é—´</div>
            </div>
        </div>
        <pre id="env-details"></pre>
    </div>

    <div class="health-card">
        <h2>ğŸ“ æ•°æ®æ–‡ä»¶æ£€æŸ¥ <span id="data-status" class="status status-loading">æ£€æŸ¥ä¸­...</span></h2>
        <div class="grid">
            <div class="metric">
                <div class="metric-number" id="total-files">-</div>
                <div class="metric-label">æ€»æ–‡ä»¶æ•°</div>
            </div>
            <div class="metric">
                <div class="metric-number" id="available-countries">-</div>
                <div class="metric-label">å¯ç”¨å›½å®¶</div>
            </div>
            <div class="metric">
                <div class="metric-number" id="date-range">-</div>
                <div class="metric-label">æ—¥æœŸèŒƒå›´</div>
            </div>
        </div>
        <div>
            <button onclick="checkDataFiles()">ğŸ”„ é‡æ–°æ£€æŸ¥</button>
            <button onclick="checkSampleFiles()">ğŸ§ª æ£€æŸ¥ç¤ºä¾‹æ–‡ä»¶</button>
        </div>
        <pre id="data-results"></pre>
    </div>

    <div class="health-card">
        <h2>ğŸ”— ç½‘ç»œè¿æ¥æ£€æŸ¥ <span id="network-status" class="status status-loading">æ£€æŸ¥ä¸­...</span></h2>
        <div>
            <button onclick="testNetworkConnectivity()">ğŸŒ æµ‹è¯•è¿æ¥</button>
            <button onclick="testCORS()">ğŸ”’ æµ‹è¯•CORS</button>
        </div>
        <pre id="network-results"></pre>
    </div>

    <div class="health-card">
        <h2>ğŸ› ï¸ å¿«é€Ÿæ“ä½œ</h2>
        <button onclick="location.href='index.html'">ğŸ  è¿”å›ä¸»é¡µ</button>
        <button onclick="location.href='test.html'">ğŸ§ª è¯¦ç»†æµ‹è¯•</button>
        <button onclick="downloadLogs()">ğŸ“¥ ä¸‹è½½æ—¥å¿—</button>
        <button onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
    </div>

    <script src="data-index.js"></script>
    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            logs.push({ timestamp, message, type });
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function getBasePath() {
            if (window.location.hostname.includes('github.io')) {
                return '/BingWallpaperCollector';
            }
            return '';
        }

        // æ— ç¼“å­˜fetchå‡½æ•°ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
        async function fetchWithoutCache(url, options = {}) {
            const timestamp = Date.now();
            const separator = url.includes('?') ? '&' : '?';
            const cacheBustUrl = `${url}${separator}t=${timestamp}&nocache=1`;

            const defaultOptions = {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0',
                    ...options.headers
                }
            };

            return fetch(cacheBustUrl, { ...options, ...defaultOptions });
        }

        function updateEnvInfo() {
            const envType = window.location.hostname.includes('github.io') ? 'GitHub Pages' : 'æœ¬åœ°å¼€å‘';
            const basePath = getBasePath() || '(æ ¹è·¯å¾„)';

            document.getElementById('env-type').textContent = envType;
            document.getElementById('base-path').textContent = basePath;
            document.getElementById('current-time').textContent = new Date().toLocaleTimeString('zh-CN');

            document.getElementById('env-details').textContent =
                `URL: ${window.location.href}\n` +
                `ä¸»æœº: ${window.location.hostname}\n` +
                `è·¯å¾„: ${window.location.pathname}\n` +
                `åŸºç¡€è·¯å¾„: ${basePath}\n` +
                `ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 80)}...`;
        }

        async function checkDataFiles() {
            log('å¼€å§‹æ£€æŸ¥æ•°æ®æ–‡ä»¶...');
            const status = document.getElementById('data-status');
            const results = document.getElementById('data-results');

            status.textContent = 'æ£€æŸ¥ä¸­...';
            status.className = 'status status-loading';

            try {
                const basePath = getBasePath();

                // ä½¿ç”¨æ•°æ®ç´¢å¼•è·å–å®é™…å¯ç”¨çš„å›½å®¶å’Œæ—¥æœŸ
                let countries, dates;
                if (window.WALLPAPER_DATA_INDEX) {
                    countries = window.WALLPAPER_DATA_INDEX.countries.slice(0, 5); // æ£€æŸ¥å‰5ä¸ªå›½å®¶
                    dates = window.WALLPAPER_DATA_INDEX.dates;
                    log(`ä»æ•°æ®ç´¢å¼•è·å–: ${countries.length}ä¸ªå›½å®¶, ${dates.length}ä¸ªæ—¥æœŸ`);
                } else {
                    // å›é€€åˆ°é¢„è®¾å€¼
                    countries = ['China', 'UnitedStates', 'Japan', 'Germany', 'France'];
                    dates = ['2025-08-28', '2025-08-27'];
                    log('æ•°æ®ç´¢å¼•ä¸å¯ç”¨ï¼Œä½¿ç”¨é¢„è®¾å€¼');
                }

                let totalFiles = 0;
                let successfulFiles = 0;
                let availableCountries = new Set();
                let availableDates = new Set();
                let resultText = 'ğŸ“Š æ•°æ®æ–‡ä»¶æ£€æŸ¥ç»“æœ:\n\n';

                for (const country of countries) {
                    for (const date of dates) {
                        const url = `${basePath}/archive/${country}/${date}.json`;
                        totalFiles++;

                        try {
                            log(`æ£€æŸ¥æ–‡ä»¶: ${url}`);
                            const response = await fetchWithoutCache(url);
                            if (response.ok) {
                                const data = await response.json();
                                successfulFiles++;
                                availableCountries.add(country);
                                availableDates.add(date);
                                resultText += `âœ… ${country}/${date} - ${data.title}\n`;
                                log(`æ–‡ä»¶å¯ç”¨: ${country}/${date}`, 'success');
                            } else {
                                resultText += `âŒ ${country}/${date} - HTTP ${response.status}\n`;
                                log(`æ–‡ä»¶ä¸å¯ç”¨: ${country}/${date} (${response.status})`, 'error');
                            }
                        } catch (error) {
                            resultText += `âŒ ${country}/${date} - ${error.message}\n`;
                            log(`æ–‡ä»¶é”™è¯¯: ${country}/${date} - ${error.message}`, 'error');
                        }

                        // çŸ­æš‚å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                document.getElementById('total-files').textContent = `${successfulFiles}/${totalFiles}`;
                document.getElementById('available-countries').textContent = availableCountries.size;

                const dateArray = Array.from(availableDates).sort();
                document.getElementById('date-range').textContent =
                    dateArray.length > 0 ? `${dateArray[0]} - ${dateArray[dateArray.length - 1]}` : 'æ— ';

                results.textContent = resultText +
                    `\nğŸ“ˆ ç»Ÿè®¡:\n` +
                    `- æˆåŠŸ: ${successfulFiles}/${totalFiles}\n` +
                    `- å¯ç”¨å›½å®¶: ${availableCountries.size}\n` +
                    `- æ—¥æœŸèŒƒå›´: ${dateArray.length} ä¸ªæ—¥æœŸ`;

                if (successfulFiles > 0) {
                    status.textContent = 'æ­£å¸¸';
                    status.className = 'status status-ok';
                    log('æ•°æ®æ–‡ä»¶æ£€æŸ¥å®Œæˆ - æ­£å¸¸', 'success');
                } else {
                    status.textContent = 'å¼‚å¸¸';
                    status.className = 'status status-error';
                    log('æ•°æ®æ–‡ä»¶æ£€æŸ¥å®Œæˆ - æ— å¯ç”¨æ–‡ä»¶', 'error');
                }

            } catch (error) {
                status.textContent = 'é”™è¯¯';
                status.className = 'status status-error';
                results.textContent = `æ£€æŸ¥å¤±è´¥: ${error.message}`;
                log(`æ•°æ®æ–‡ä»¶æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkSampleFiles() {
            log('æ£€æŸ¥ç¤ºä¾‹æ–‡ä»¶...');
            const basePath = getBasePath();
            const sampleFiles = [
                'archive/China/2025-08-28.json',
                'assets/js/app.js',
                'assets/css/style.css',
                'data-index.js'
            ];

            let results = 'ğŸ” ç¤ºä¾‹æ–‡ä»¶æ£€æŸ¥:\n\n';

            for (const file of sampleFiles) {
                try {
                    const url = `${basePath}/${file}`;
                    const response = await fetchWithoutCache(url, { method: 'HEAD' });
                    const size = response.headers.get('content-length');
                    const sizeText = size ? `(${(size / 1024).toFixed(1)}KB)` : '';

                    if (response.ok) {
                        results += `âœ… ${file} ${sizeText}\n`;
                        log(`ç¤ºä¾‹æ–‡ä»¶å­˜åœ¨: ${file}`, 'success');
                    } else {
                        results += `âŒ ${file} - HTTP ${response.status}\n`;
                        log(`ç¤ºä¾‹æ–‡ä»¶ä¸å­˜åœ¨: ${file}`, 'error');
                    }
                } catch (error) {
                    results += `âŒ ${file} - ${error.message}\n`;
                    log(`ç¤ºä¾‹æ–‡ä»¶é”™è¯¯: ${file} - ${error.message}`, 'error');
                }
            }

            document.getElementById('data-results').textContent = results;
        }

        async function testNetworkConnectivity() {
            log('æµ‹è¯•ç½‘ç»œè¿æ¥...');
            const status = document.getElementById('network-status');
            const results = document.getElementById('network-results');

            status.textContent = 'æµ‹è¯•ä¸­...';
            status.className = 'status status-loading';

            let resultText = 'ğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•:\n\n';

            // æµ‹è¯•GitHub API
            try {
                const start = Date.now();
                const response = await fetch('https://api.github.com/repos/hippieZhou/BingWallpaperCollector');
                const duration = Date.now() - start;
                const data = await response.json();

                resultText += `âœ… GitHub API - ${duration}ms\n`;
                resultText += `   ä»“åº“: ${data.name}\n`;
                resultText += `   æ›´æ–°: ${new Date(data.updated_at).toLocaleString('zh-CN')}\n\n`;
                log('GitHub APIè¿æ¥æ­£å¸¸', 'success');
            } catch (error) {
                resultText += `âŒ GitHub API - ${error.message}\n\n`;
                log(`GitHub APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }

            results.textContent = resultText;
            status.textContent = 'å®Œæˆ';
            status.className = 'status status-ok';
        }

        async function testCORS() {
            log('æµ‹è¯•CORSè®¾ç½®...');
            const basePath = getBasePath();
            const testUrl = `${basePath}/archive/China/2025-08-28.json`;

            try {
                const response = await fetchWithoutCache(testUrl);
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('access-control-allow-origin'),
                    'Access-Control-Allow-Methods': response.headers.get('access-control-allow-methods'),
                    'Content-Type': response.headers.get('content-type')
                };

                let results = 'ğŸ”’ CORSæµ‹è¯•ç»“æœ:\n\n';
                results += `æµ‹è¯•URL: ${testUrl}\n`;
                results += `çŠ¶æ€: ${response.status} ${response.statusText}\n\n`;
                results += `å“åº”å¤´:\n`;
                Object.entries(corsHeaders).forEach(([key, value]) => {
                    results += `  ${key}: ${value || '(æœªè®¾ç½®)'}\n`;
                });

                document.getElementById('network-results').textContent = results;
                log('CORSæµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                document.getElementById('network-results').textContent = `CORSæµ‹è¯•å¤±è´¥: ${error.message}`;
                log(`CORSæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function downloadLogs() {
            const logText = logs.map(entry =>
                `[${entry.timestamp}] [${entry.type.toUpperCase()}] ${entry.message}`
            ).join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `health-check-${new Date().toISOString().slice(0, 19)}.log`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('æ—¥å¿—å·²ä¸‹è½½', 'info');
        }

        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            localStorage.clear();
            sessionStorage.clear();
            log('ç¼“å­˜å·²æ¸…é™¤', 'info');
            alert('ç¼“å­˜å·²æ¸…é™¤ï¼Œè¯·åˆ·æ–°é¡µé¢');
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('å¥åº·æ£€æŸ¥é¡µé¢åŠ è½½å®Œæˆ', 'info');
            updateEnvInfo();
            checkDataFiles();

            // æ¯30ç§’æ›´æ–°æ—¶é—´
            setInterval(updateEnvInfo, 30000);
        });
    </script>
</body>

</html>